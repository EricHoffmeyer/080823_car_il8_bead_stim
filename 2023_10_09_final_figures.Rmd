---
title: "2023_10_09_final_figures"
author: "Eric Hoffmeyer"
date: "2023-10-09"
output: html_document
---

Customizing figures for final submission

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries

```{r}
suppressPackageStartupMessages({
library(tidyverse)
library(plotly)
library(GeneTonic)
library(ComplexHeatmap)
library(DESeq2)
library(pheatmap)
library(EnhancedVolcano)
})
```

# Read in data

```{r load genetonic inputs}
load("genetonic_results/il8_GeneTonic_inputs.Rdata")
de_genes <- read.csv(file = "deseq_results/il8_DESeq2_analysis.csv")
```

```{r dir folders}
folder.name <- "Analysis_2023_10_09"

if(!exists(folder.name)){
  dir.create(folder.name)
}
```

## Pathway Summary Plot

```{r pathway plot}
il8_summary <- gs_summary_overview(res_enrich = il8.topgo.res.sf.df.dds, 
                                   n_gs = 15,
                                   )

o <- il8_summary +
  labs(title = "Pathway Enrichment",
       subtitle = "B7H3-CXCR2 CAR vs B7H3 CAR") +
  theme(text = element_text(size = 15, face = "bold"),
        title = element_text(size = 15, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 15, face = "bold"),
        axis.title.y = element_text(size = 15, face = "bold"))
o
```


```{r}
ggsave(filename = paste0(folder.name, "/pathway_enrichment_gene_sets.png"),
       plot = o,
       width = 11,
       height = 8,
       units = "in",
       bg = "white")
```

## Innate Immune Response: gene heatmap

```{r IIR heatmap}
iir_heatmap <- gs_heatmap(se = vst(il8.sf.df.dds),
           res_de = il8.res.sf.df.dds,
           res_enrich = il8.topgo.res.sf.df.dds,
           annotation_obj = il8.sf.df.annotation,
           geneset_id = "GO:0045087",
           cluster_columns = TRUE,
           anno_col_info = "CAR",
           scale_row = TRUE,
           plot_title = "Innate Immune Response (GO:0045087)")

#remove labels at bottom
# change color of CAR labels- orange for BC2, blue for B7
#Move B7 samples to left side of plot
# what p cutoff value was used
```

I can't quite figure out how to make changes to this gs_heatmap object. It may be easier to use the raw data and make a pHeatmap. 

First, let me extract the genes of interest for the innate immune response pathway from this gs_heatmap object

```{r}
iir_gene_list <- il8_summary$data[[12,4]] |> 
  strsplit(split = ",")

iir_gene_list <- iir_gene_list[[1]]
```

Isolate the counts from just the significant genes in the innate immune response list.

```{r}
iir_matrix <- de_genes |> 
  na.omit() |> 
  filter(padj <= 0.05) |>
  filter(gene_symbol %in% iir_gene_list) |> 
  column_to_rownames(var = "gene_symbol") |> 
  dplyr::select(contains("B7"))
```

Preparing the annotation names and colors here. Jessica's other graphpad figures have B7H3 in orange and B7H3-CXCR2 as blue, so I will assign those to keep the color scheme consistent.

```{r}
b7c2_samples <- c("D1_B7C2_Il8", "D2_B7C2_Il8", "D3_B7C2_Il8")

anno <- data.frame(sample_name = colnames(iir_matrix)) |> 
  mutate(CAR = if_else(sample_name %in% b7c2_samples, "B7H3-CXCR2", "B7H3")) |> 
  column_to_rownames("sample_name")

CAR <- c("#FFCC00", "blue")
names(CAR) <- c("B7H3", "B7H3-CXCR2")
anno_colors <- list(CAR = CAR)
```

Make heatmap

```{r}
p <- pheatmap(iir_matrix, 
         scale = "row",
         fontsize = 12,
         fontsize_row = 15,
         show_colnames = FALSE,
         treeheight_col = 0,
         annotation = anno,
         annotation_colors = anno_colors,
         main = "Innate Immune Response (GO:0045087)")
```

Save heatmap

```{r}
ggsave(filename = paste0(folder.name, "/innate_immune_response_heatmap_row15.png"),
       plot = p,
       width = 7,
       height = 9,
       units = "in")
```


## Heatmap for top 25 overall DESeq2 genes

Jessica asked for the "top 25" genes. We will do two heatmaps. One by adjusted p value and another by log2FC (and still p < 0.05).
The DESeq gene list is already sorted by adjusted p value, so we can start there. I'm boosting the gene level to 26 since we artifically increased CXCR2 expression.

```{r}
top_25_padj <- de_genes |> 
  na.omit() |> 
  dplyr::slice(1:26) |> 
  column_to_rownames(var = "gene_symbol") |> 
  dplyr::select(contains("B7"))
  
```


```{r}
top_25_log2 <- de_genes |> 
  na.omit() |> 
  filter(padj <= 0.05) |> 
  arrange(desc(log2FoldChange)) |> 
  column_to_rownames(var = "gene_symbol") |> 
  dplyr::select(contains("B7")) |> 
  dplyr::slice(1:25)
```

Top 25 DESeq genes by adjusted p value heatmap

```{r}
q <- pheatmap(top_25_padj,
         scale = "row",
         show_colnames = FALSE,
         treeheight_col = 0,
         annotation = anno,
         annotation_colors = anno_colors,
         main = "Top 26 genes by adjusted p value: CAR+IL8 stim")

ggsave(filename = paste0(folder.name, "/top_25_padj_heatmap.png"),
       plot = q,
       width = 7,
       height = 9,
       units = "in")
```

Top 25 DESeq genes by fold change.

```{r}
r <- pheatmap(top_25_log2,
         scale = "row",
         fontsize = 11,
         fontsize_row = 15,
         show_colnames = FALSE,
         treeheight_col = 0,
         annotation = anno,
         annotation_colors = anno_colors,
         main = "Top 25 genes by log2FC value: CAR+IL8 stim")
ggsave(filename = paste0(folder.name, "/top_25_log2FC_heatmap.png"),
       plot = r,
       width = 7,
       height = 9,
       units = "in")
```

## Volcano plots for DE genes.

```{r}
v <- EnhancedVolcano(toptable = de_genes,
                lab = de_genes$gene_symbol,
                x = "log2FoldChange",
                y = "padj",
                xlim =  c(-3, 3),
                ylim = c(-0.5, 8),
                title = "B7H3-CXCR2 vs B7H3 CAR T cells",
                subtitle = "IL8 + CAR stim condition",
                FCcutoff = 0.25,
                pCutoff = 0.01,
                legendPosition = "none",
                #labFace = "bold",
                caption = ""
                )
v
```

```{r}
ggsave(filename = paste0(folder.name, "/BC_vs_B7_IL8_condtion_volcano_plot.png"),
       plot = v,
       width = 7,
       height = 6,
       units = "in",
       dpi = 700
       )
```

# 2023_10_27 Update

More requested graphs. To avoid confusion with previous requests, I will make a new subfolder

```{r}
subfolder.name <- "/2023_10_27_update"

if(!exists(subfolder.name)){
  dir.create(paste0(folder.name, subfolder.name))
}
```

The new requests are:

  1. Top 25 genes, by log2FC and padj, for BC IL8 stim vs BC no stim.

  2. Top 25 genes by logFC heatmap for BC no stim vs B7 no stim: 

  3. Heatmap or volcano plot of top 25 genes by logFC of BC IL8 stim vs B7 IL8 stim

He have #3 objects loaded already, so we can start with that

## Heatmap/Volcano plot for top 25 log2FC BC IL8 vs B7 IL8

de_genes current lists the DESeq2 results for BC Il8 vs B7 IL8. Make a subset of the top 25

```{r}
top_25_volcano <- de_genes |> 
  na.omit() |> 
  filter(padj <= 0.05) |> 
  arrange(desc(log2FoldChange)) |> 
  column_to_rownames(var = "gene_symbol") |> 
  dplyr::slice(1:25)
```

```{r}
s <- EnhancedVolcano(toptable = top_25_volcano,
                lab = rownames(top_25_volcano),
                x = "log2FoldChange",
                y = "padj",
                xlim =  c(-1, 3),
                ylim = c(-0.5, 8),
                title = "B7H3-CXCR2 vs B7H3 CAR T cells",
                subtitle = "IL8 + CAR stim condition",
                FCcutoff = 0.5,
                pCutoff = 0.05,
                legendPosition = "none",
                #labFace = "bold",
                caption = "",
                max.overlaps = Inf,
                #drawConnectors = T
                ) 
s
```

```{r}
ggsave(filename = paste0(folder.name, subfolder.name, "/BC_vs_B7_IL8_condtion_volcano_plot_no_connectors.png"),
       plot = s,
       width = 7,
       height = 6,
       units = "in",
       dpi = 700
       )
```

I will use the heatmap generated previously. This task finished.

## Top 25 genes by logFC heatmap for BC no stim vs B7 no stim

This is the next easiest task. Begin by reading in the DESeq data:

```{r}
no_stim_de_genes <- read.csv(file = "deseq_results/no_stim_DESeq2_anaylsis.csv")
```

Make variables of top 25 genes by padj and log2FC:

```{r}
no_stim_t25_log2 <- no_stim_de_genes |> 
  na.omit() |> 
  filter(padj <= 0.05) |> 
  arrange(desc(log2FoldChange)) |> 
  column_to_rownames(var = "gene_symbol") |> 
  dplyr::slice(1:25)

#dplyr::select(contains("B7")) use this later for heatmap

no_stim_t25_padj <- no_stim_de_genes |> 
  na.omit() |> 
  dplyr::slice(1:25) |> 
  column_to_rownames(var = "gene_symbol")
```

```{r}
b7c2_samples <- c("D1_B7C2_no", "D2_B7C2_no", "D3_B7C2_no")
```
```{r}
t <- EnhancedVolcano(toptable = top_25_volcano,
                lab = rownames(top_25_volcano),
                x = "log2FoldChange",
                y = "padj",
                xlim =  c(-1, 3),
                ylim = c(-0.5, 8),
                title = "B7H3-CXCR2 vs B7H3 CAR T cells",
                subtitle = "IL8 + CAR stim condition",
                FCcutoff = 0.5,
                pCutoff = 0.05,
                legendPosition = "none",
                #labFace = "bold",
                caption = "",
                max.overlaps = Inf,
                #drawConnectors = T
                ) 
t
```











## Top 25 genes, by log2FC and padj, for BC IL8 stim vs BC no stim. And GeneTonic pathways

This requires a new subsetting of the original bulkRNAseq, since all the previous condtions were BC vs B7 for a single condition, not across conditions.

## Data Dictionary - copy/pasted from 2023_08_16_bulk_RNAseq_subset_analysis.Rmd

Creating a variable with the names of all the sample folders

```{r dir.names}
dir.names = c(
"quant_files/D1_B7C2_Il8_stim_S8_L002",
"quant_files/D1_B7C2_bead_stim_S14_L002",
"quant_files/D1_B7C2_no_stim_S2_L002",
"quant_files/D1_B7_Il8_stim_S7_L002",
"quant_files/D1_B7_bead_stim_S13_L002",
"quant_files/D1_B7_no_stim_S1_L002",
"quant_files/D2_B7C2_Il8_stim_S10_L002",
"quant_files/D2_B7C2_bead_stim_S16_L002",
"quant_files/D2_B7C2_no_stim_S4_L002",
"quant_files/D2_B7_Il8_stim_S9_L002",
"quant_files/D2_B7_bead_stim_S15_L002",
"quant_files/D2_B7_no_stim_S3_L002",
"quant_files/D3_B7C2_Il8_stim_S12_L002",
"quant_files/D3_B7C2_bead_stim_S18_L002",
"quant_files/D3_B7C2_no_stim_S6_L002",
"quant_files/D3_B7_Il8_stim_S11_L002",
"quant_files/D3_B7_bead_stim_S17_L002",
"quant_files/D3_B7_no_stim_S5_L002"
)
```

```{r load libraries}
suppressPackageStartupMessages({
library(tidybulk)
library(janitor)
library(plotly)
library(GeneTonic)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(topGO)
})
```

Convert the `vector` to `data.frame`.

```{r data dictionary start}
Data.dictionary <- data.frame(Orig.Name = dir.names, Folder.Name = dir.names) %>% 
  mutate(Folder.Name = str_remove(Folder.Name, pattern = "quant_files/"))
```

Perform these steps to transform the `data.frame` into desirable format.

```{r format data dictionary}
Data.dictionary <- Data.dictionary %>% 
  ## Create or duplicate the "Orig.Name" column and called it "Dup"
  mutate(Dup = Folder.Name) %>% 
  ## Breakup (separate) the "Dup" column using "_" as its separator
  separate_wider_delim(Dup, names = c("donor", "CAR", "stim", "line1", "line2", "line3"), delim = "_") %>%
  ## Create a new column called "col.name" by modifying "Orig.Name"
  ## by removing "_S(any digit)_L002"
  mutate(col.name = str_remove(Folder.Name, pattern = "_stim_S([:digit:]+)_L002")) %>%
  # Relocate the new "col.name" column right after the first column; "Org.Name"
  # relocate(col.name, .after = Orig.Name) %>% 
  ## Make donor, CAR, and stim columns a factors
  mutate(donor = as.factor(donor)) %>% 
  mutate(CAR = as.factor(CAR)) %>% 
  mutate(stim = as.factor(stim)) %>% 
  # mutate(col.name = str_c(donor, CAR, stim, sep = "_")) %>% 
  ## Remove line1, line2, line3 columns, as we don't need them.
  dplyr::select(-c("line1", "line2", "line3"))
```

### Load the saved copy

```{r load sf.df}
load(file = "data/sf.df.Rdata")
```

Subset data to BC CARs, and remove the bead condiiton

```{r}
bc.il8.vs.none.subset <- dplyr::filter(Data.dictionary, CAR == "B7C2" & stim != "bead")

bc.il8.vs.none.subset <- bc.il8.vs.none.subset$col.name

```

```{r}
bc.il8.vs.none.dictionary <- dplyr::filter(Data.dictionary, col.name %in% bc.il8.vs.none.subset)
```

```{r}
bc.il8.vs.none.data <- sf.df %>%
  dplyr::select(all_of(bc.il8.vs.none.subset)) %>%
  drop_na() %>% 
  ## Filter low expressors (<10)
  mutate(Rowsum = apply(., 1, function(x) sum(x >= 5))) %>% 
  dplyr::filter(Rowsum == dim(bc.il8.vs.none.dictionary)[1]) %>% 
  ## no longer need the column "Rowsum", we can remove it
  dplyr::select(-Rowsum)
```


### Create SummarizeExperiment Object

```{r}
bc.il8.vs.none.sf.df.se <- SummarizedExperiment(assays = list(counts = as.matrix(bc.il8.vs.none.data)),
                                colData = bc.il8.vs.none.dictionary)
```

### Create DESeq Object

The design will use CAR as the factor to run the comparison.

```{r}
bc.il8.vs.none.sf.df.dds <- DESeqDataSet(bc.il8.vs.none.sf.df.se, design = ~stim)
```

### DE Analysis

#### Statistical Analysis

```{r}
bc.il8.vs.none.sf.df.dds <- DESeq(bc.il8.vs.none.sf.df.dds)
```

### Analysis Result

```{r results()}
bc.il8.vs.none.res.sf.df.dds <- results(bc.il8.vs.none.sf.df.dds,
                        contrast = c("stim", "Il8", "no"),
                        alpha = 0.05)
```

### annotation Table

```{r start annotation tables}
bc.il8.vs.none.data.df <- bc.il8.vs.none.data %>% 
  rownames_to_column(var = "gene_id")
```

```{r}
bc.il8.vs.none.res.sf.df.dds.annotation <- deseqresult2df(bc.il8.vs.none.res.sf.df.dds) %>% 
  dplyr::rename(gene_id = id) %>% 
  mutate(gene_symbol = mapIds(org.Hs.eg.db, keys = gene_id, keytype = "ENSEMBL", column = "SYMBOL", multiVals = "first")) %>% 
  mutate(gene_entrez = mapIds(org.Hs.eg.db, keys = gene_id, keytype = "ENSEMBL", column = "ENTREZID", multiVals = "first")) %>% 
  mutate(gene_desc = mapIds(org.Hs.eg.db, keys = gene_id, keytype = "ENSEMBL", column = "GENENAME", multiVals = "first")) %>% 
  relocate(gene_symbol, gene_entrez, gene_desc, .after = gene_id) %>% 
  left_join(bc.il8.vs.none.data.df, by = c("gene_id"="gene_id"))

View(bc.il8.vs.none.res.sf.df.dds.annotation)
```

### Export Result

Write DESeq results to cxv files

```{r write DESeq results}
write_csv(bc.il8.vs.none.res.sf.df.dds.annotation, file = paste0(folder.name, subfolder.name, "/BC_il8_vs_no_stim_deseq.csv"))
```

### Top 25 genes heatmaps, by log2FC and padj, for BC IL8 stim vs BC no stim. And GeneTonic pathways

#### Heatmaps






















### GeneTonic annotation

```{r create/format annotation df for GeneTonic}
bc.il8.vs.none.res.sf.df.dds.annotation <- deseqresult2df(bc.il8.vs.none.res.sf.df.dds) %>% 
  dplyr::rename(gene_id = id) %>% 
  mutate(gene_name = mapIds(org.Hs.eg.db, 
                            keys = gene_id, 
                            keytype = "ENSEMBL", 
                            column = "SYMBOL", 
                            multiVals = "first")) %>% 
  dplyr::select(gene_id, gene_name) 

```
```{r}
sig.gene.cutoff = 0.05 ## Reduce significant gene list only p adjusted significant genes

bc.il8.vs.none.res.sf.df.dds.annotation %>% 
  dplyr::filter(padj <= sig.gene.cutoff)
```













